# accept an image tag build argument to define a "copy_from_app_image" FROM image to copy the prebuilt app from
ARG copy_from_tag=latest
FROM lardbit/nefarious:${copy_from_tag} as copy_from_app_image

# base image - copy pre-built app from "copy_from_app_image" image
FROM resin/armv7hf-ubuntu
WORKDIR /app
COPY --from=copy_from_app_image /app .
RUN ["cross-build-start"]
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    python3.8 \
    python3.8-venv \
    python3.8-dev \
    python3.8-gdbm \
    python3-venv \
    git
RUN python3.8 -m venv /env
RUN /env/bin/pip install -r requirements.txt
RUN ["cross-build-end"]

# app image
FROM resin/armv7hf-ubuntu
COPY --from=0 /app /app
COPY --from=0 /env /env

EXPOSE 80

ENTRYPOINT ["/app/docker-entrypoint.sh"]
